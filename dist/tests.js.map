{"version":3,"sources":["../src/index.ts","../src/cli.ts","../src/command.ts","../src/commands.ts","../src/primary.ts","../src/queue.ts","../src/primaryEvents.ts","../src/workerEvents.ts","../src/worker.ts","../tests/primaryTest.ts"],"sourcesContent":["import type {\r\n  CliDefinition,\r\n  CommandAction,\r\n  KeyPair,\r\n  QuickSends,\r\n} from './index.d';\r\nimport cluster from 'cluster';\r\nimport { Cli } from './cli';\r\nimport { Primary } from './primary';\r\nimport { defaultCommands } from './commands';\r\nimport { Command } from './command';\r\nimport { Worker } from './worker';\r\n\r\nconst noop = () => undefined;\r\n\r\nexport class Cluster {\r\n  cliCommands: CliDefinition[] = [];\r\n  useLogging: boolean;\r\n  onPrimaryCommand: CommandAction = noop;\r\n  onWorkerCommand: CommandAction = noop;\r\n\r\n  constructor(commands: CliDefinition[] = [], useLogging: boolean = false) {\r\n    this.useLogging = useLogging;\r\n\r\n    // Default actions\r\n    for (const defaultCommand of defaultCommands.concat(commands)) {\r\n      if (defaultCommand.command.indexOf('cli:') === 0) {\r\n        // Register CLI commands\r\n        this.cliCommands.push(defaultCommand);\r\n      } else {\r\n        // Register actions\r\n        Command.register(defaultCommand.command, defaultCommand.action);\r\n      }\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Cluster node command handlers\r\n   */\r\n  onCommand(onPrimaryCommand: CommandAction, onWorkerCommand: CommandAction) {\r\n    this.onPrimaryCommand = onPrimaryCommand;\r\n    this.onWorkerCommand = onWorkerCommand;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Start the cluster nodes\r\n   */\r\n  async start(\r\n    onPrimaryStart: (primary: Primary) => Promise<void> = noop,\r\n    onWorkerStart: (worker: Worker) => Promise<void> = noop\r\n  ) {\r\n    if (cluster.isPrimary) {\r\n      const cli = new Cli(this.cliCommands);\r\n      const primary = new Primary(\r\n        cluster,\r\n        cli,\r\n        this.onPrimaryCommand,\r\n        this.useLogging\r\n      );\r\n\r\n      // Parse the CLI\r\n      cli.start();\r\n\r\n      // Wait for the primary queue to be empty\r\n      await primary.start();\r\n      await onPrimaryStart(primary);\r\n    } else {\r\n      await onWorkerStart(\r\n        new Worker(cluster.worker, this.onWorkerCommand, this.useLogging)\r\n      );\r\n    }\r\n  }\r\n}\r\n","import type { CliDefinition, KeyPair } from './index.d';\r\nimport cluster from 'cluster';\r\nimport { Command as Commander } from 'commander';\r\nimport { Command } from './command';\r\nimport { internalCommands } from './commands';\r\n\r\nconst { name, description, version } = require('../package.json');\r\n\r\nconst removeChars = /[^A-Za-z0-9_]/g;\r\n\r\nexport class Cli {\r\n  program: Commander;\r\n\r\n  constructor(definitions: CliDefinition[]) {\r\n    this.program = new Commander();\r\n    this.program.name(name).description(description).version(version);\r\n\r\n    for (const definition of definitions) {\r\n      this.register(definition);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Registers a new CLI command\r\n   */\r\n  register(definition: CliDefinition) {\r\n    if (!cluster.isPrimary) {\r\n      return;\r\n    }\r\n\r\n    const commandName = definition.command.substring(4);\r\n\r\n    // Register the definition as a command\r\n    Command.register(definition.command, definition.action);\r\n\r\n    // Register the command\r\n    const newCommand =\r\n      commandName === '' ? this.program : this.program.command(commandName);\r\n\r\n    newCommand.description(definition.description);\r\n\r\n    // Define the end-of-line arguments\r\n    const argKeys = Object.keys(definition.args);\r\n\r\n    for (const arg of argKeys) {\r\n      const description = definition.args[arg];\r\n\r\n      newCommand.argument(arg, description);\r\n    }\r\n\r\n    // Define the flags/options\r\n    for (const option of Object.keys(definition.options)) {\r\n      const description = definition.options[option];\r\n\r\n      newCommand.option(option, description);\r\n    }\r\n\r\n    // program.action(definition.action);\r\n    newCommand.action((...args: string[] & [(KeyPair | string)?]) => {\r\n      const options =\r\n        typeof args[args.length - 2] === 'string'\r\n          ? {}\r\n          : (args[args.length - 2] as KeyPair);\r\n\r\n      options.cli = {};\r\n\r\n      let i = 0;\r\n      for (const key of argKeys) {\r\n        options.cli[key.replace(removeChars, '')] = args[i];\r\n        i += 1;\r\n      }\r\n\r\n      cluster.emit(\r\n        'message',\r\n        new Command(\r\n          definition.command,\r\n          options,\r\n          'cli',\r\n          internalCommands.enqueueJobPrimary\r\n        )\r\n      );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Start the CLI\r\n   */\r\n  start() {\r\n    this.program.parse(process.argv);\r\n  }\r\n}\r\n","import type {\r\n  CommandAction,\r\n  CommandFrom,\r\n  CommandTo,\r\n  iCommand,\r\n  KeyPair,\r\n  QuickSends,\r\n} from './index.d';\r\n\r\nconst commands: KeyPair<CommandAction> = {};\r\n\r\nexport class Command implements iCommand {\r\n  command: string;\r\n  args: KeyPair;\r\n  from: CommandFrom;\r\n  to: CommandTo;\r\n\r\n  /**\r\n   * Registers a new command\r\n   */\r\n  static register(command: string, onAction: CommandAction) {\r\n    commands[command] = onAction;\r\n  }\r\n\r\n  /**\r\n   * Generates a command from a JSON\r\n   */\r\n  static fromJSON(json: KeyPair) {\r\n    return new Command(json.command, json.args, json.from, json.to);\r\n  }\r\n\r\n  /**\r\n   * Constructor\r\n   */\r\n  constructor(\r\n    command: string,\r\n    args: KeyPair,\r\n    from: CommandFrom,\r\n    to: CommandTo\r\n  ) {\r\n    if (commands[command] === undefined && command[0] !== '_') {\r\n      throw new RangeError(`\"${command}\" has not been registered.`);\r\n    }\r\n\r\n    this.command = command;\r\n    this.args = args;\r\n    this.from = from;\r\n    this.to = to;\r\n  }\r\n\r\n  /**\r\n   * Clones a command and changes the to and from properties\r\n   */\r\n  clone(from: CommandFrom, to: CommandTo) {\r\n    return new Command(this.command, this.args, from, to);\r\n  }\r\n\r\n  /**\r\n   * Runs the command\r\n   */\r\n  async run(state: KeyPair, quickSends: QuickSends) {\r\n    return commands[this.command](this, state, quickSends);\r\n  }\r\n\r\n  /**\r\n   *\r\n   */\r\n  log(from?: string) {\r\n    console.log(\r\n      `[${from || this.from} -> ${this.to}] ${this.command}`,\r\n      this.args\r\n    );\r\n  }\r\n}\r\n","import type { CliDefinition, KeyPair, QuickSends } from './index.d';\r\n\r\nimport { Command } from './command';\r\n\r\nexport const internalCommands: {\r\n  getNextJob: '_getNextJob';\r\n  getNextPrimaryJob: '_getNextJob_primary';\r\n  enqueueJob: '_enqueueJob';\r\n  enqueueJobPrimary: '_enqueueJob_primary';\r\n  newJobNotice: '_newJobNotice';\r\n  message: 'message';\r\n} = {\r\n  getNextJob: '_getNextJob',\r\n  getNextPrimaryJob: '_getNextJob_primary',\r\n  enqueueJob: '_enqueueJob',\r\n  enqueueJobPrimary: '_enqueueJob_primary',\r\n  newJobNotice: '_newJobNotice',\r\n  message: 'message',\r\n};\r\n\r\n/**\r\n * Default commands\r\n */\r\nexport const defaultCommands: CliDefinition[] = [\r\n  {\r\n    command: 'log',\r\n    action: async (command: Command, state: KeyPair, sends: QuickSends) => {\r\n      command.log();\r\n      console.log('State:', state);\r\n    },\r\n  },\r\n  {\r\n    command: 'setState',\r\n    action: async (command: Command, state: KeyPair, sends: QuickSends) => {\r\n      for (const key of Object.keys(command.args)) {\r\n        state[key] = command.args[key];\r\n      }\r\n    },\r\n  },\r\n  {\r\n    command: 'iterateState',\r\n    action: async (command: Command, state: KeyPair, sends: QuickSends) => {\r\n      for (const key of Object.keys(command.args)) {\r\n        if (state[key] === undefined) {\r\n          state[key] = 0;\r\n        }\r\n\r\n        state[key] += command.args[key];\r\n      }\r\n    },\r\n  },\r\n];\r\n","import type { CommandAction, KeyPair, QuickSends } from './index.d';\r\n\r\nimport cluster from 'cluster';\r\nimport * as os from 'os';\r\nimport { Cli } from './cli';\r\nimport { Command } from './command';\r\nimport { Queue } from './queue';\r\nimport { internalCommands } from './commands';\r\nimport { getPrimaryEvents } from './primaryEvents';\r\n\r\ntype Process = typeof cluster;\r\ntype Worker = typeof cluster.worker;\r\n\r\nconst cpus = os.cpus();\r\nconst numWorkers = cpus.length;\r\n\r\nexport class Primary {\r\n  process: Process;\r\n  primaryQueue: Queue;\r\n  workerQueue: Queue;\r\n  useLogging: boolean;\r\n  cli: Cli;\r\n  state: KeyPair = {};\r\n  sends: QuickSends;\r\n  onMessage: CommandAction;\r\n\r\n  constructor(\r\n    process: Process,\r\n    cli: Cli,\r\n    onMessage: CommandAction,\r\n    useLogging: boolean = false\r\n  ) {\r\n    this.cli = cli;\r\n    this.process = process;\r\n    this.useLogging = useLogging;\r\n    this.primaryQueue = new Queue();\r\n    this.workerQueue = new Queue();\r\n    this.onMessage = onMessage;\r\n    this.sends = getPrimaryEvents(this);\r\n\r\n    /**\r\n     * Primary receives a general message from worker\r\n     */\r\n    process.on(\r\n      'message',\r\n      async (worker: Worker | Command, possibleCommand?: Command) => {\r\n        const hasWorker = possibleCommand !== undefined;\r\n        const command = Command.fromJSON(possibleCommand || worker);\r\n\r\n        if (this.useLogging) {\r\n          const from = hasWorker\r\n            ? (worker as Worker).process.pid\r\n            : (worker as Command).from;\r\n\r\n          command.log(from.toString());\r\n        }\r\n\r\n        switch (command.to) {\r\n          case internalCommands.enqueueJob:\r\n            await this.enqueueJob(command);\r\n            break;\r\n\r\n          case internalCommands.getNextJob:\r\n            await this.getNextJob(worker as Worker);\r\n            break;\r\n\r\n          case internalCommands.message:\r\n            await this.message(command);\r\n            break;\r\n\r\n          case internalCommands.enqueueJobPrimary:\r\n            await this.enqueueJob(command);\r\n            break;\r\n\r\n          case internalCommands.getNextPrimaryJob:\r\n            await this.getNextPrimaryJob();\r\n            break;\r\n\r\n          case internalCommands.newJobNotice:\r\n            break;\r\n\r\n          default:\r\n            console.warn('Unknown command:', command);\r\n            return;\r\n        }\r\n      }\r\n    );\r\n\r\n    /**\r\n     * When a worker quits\r\n     */\r\n    process.on('exit', (worker, code, signal) => {\r\n      if (this.useLogging) {\r\n        console.info(`${worker.process.pid} died: ${code} ${signal}`);\r\n      }\r\n\r\n      this.spawnWorker();\r\n    });\r\n\r\n    /**\r\n     * When a worker spawns\r\n     */\r\n    process.on('online', (worker) => {\r\n      if (this.useLogging) {\r\n        console.info('Worker ' + worker.process.pid + ' is online');\r\n      }\r\n\r\n      this.getNextJob(worker);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Starts the priamry process\r\n   */\r\n  async start() {\r\n    await Promise.all([\r\n      new Promise((resolve) => {\r\n        setTimeout(() => {\r\n          if (this.primaryQueue.queue.length === 0) {\r\n            resolve(true);\r\n          }\r\n        }, 100);\r\n      }),\r\n    ]);\r\n\r\n    if (this.useLogging) {\r\n      console.info('Primary cluster setting up ' + numWorkers + ' workers...');\r\n    }\r\n\r\n    for (var i = 0; i < numWorkers; i++) {\r\n      this.spawnWorker();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Spawn a new worker that self-cleans up\r\n   */\r\n  spawnWorker() {\r\n    let worker = this.process.fork();\r\n\r\n    worker.on('disconnect', () => {\r\n      worker.removeAllListeners();\r\n      worker.kill();\r\n      worker = undefined;\r\n    });\r\n\r\n    return worker;\r\n  }\r\n\r\n  /**\r\n   * Adds a command for later processing\r\n   */\r\n  addTask(command: Command): Command {\r\n    if (command.to === 'primary') {\r\n      this.primaryQueue.add(command);\r\n    } else {\r\n      this.workerQueue.add(command);\r\n    }\r\n\r\n    return command;\r\n  }\r\n\r\n  /**\r\n   * Get worker processes\r\n   */\r\n  getWorkers() {\r\n    return Object.values(cluster.workers);\r\n  }\r\n\r\n  /**\r\n   * Enqueues a command.  If from primary, it will run the command instead\r\n   */\r\n  private async enqueueJob(command: Command) {\r\n    if (command.to === internalCommands.enqueueJobPrimary) {\r\n      // Primary should run its next command\r\n      const newCommand = await this.onMessage(command, this.state, this.sends);\r\n\r\n      if (newCommand === undefined) {\r\n        await command.run(this.state, this.sends);\r\n      } else {\r\n        await (newCommand as Command).run(this.state, this.sends);\r\n      }\r\n    } else {\r\n      // All workers should be told a new command has appeared\r\n      this.addTask(command);\r\n\r\n      if (this.process.workers) this.sends.newJobNotice();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the next job from the queue and sends it to a worker\r\n   */\r\n  private async getNextJob(worker: Worker) {\r\n    const nextCommand = this.workerQueue.getNext(worker.process.pid);\r\n\r\n    if (nextCommand === undefined) {\r\n      return;\r\n    }\r\n\r\n    const finalCommand = await this.onMessage(\r\n      nextCommand,\r\n      this.state,\r\n      this.sends\r\n    );\r\n\r\n    if (finalCommand) {\r\n      worker.send(finalCommand);\r\n    } else {\r\n      worker.send(nextCommand);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the next priamry job and runs it\r\n   */\r\n  private async getNextPrimaryJob() {\r\n    const nextCommand = this.primaryQueue.getNext('primary');\r\n\r\n    if (nextCommand === undefined) {\r\n      return;\r\n    }\r\n\r\n    // @TODO might be bad\r\n    const finalCommand = await this.onMessage(\r\n      nextCommand,\r\n      this.state,\r\n      this.sends\r\n    );\r\n\r\n    if (finalCommand === undefined) {\r\n      await nextCommand.run(this.state, this.sends);\r\n    } else {\r\n      await (finalCommand as Command).run(this.state, this.sends);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generic message handler\r\n   */\r\n  private async message(command: Command) {\r\n    if (this.useLogging) {\r\n      console.log('Primary Message:', command);\r\n    }\r\n\r\n    await this.onMessage(command, this.state, this.sends);\r\n  }\r\n}\r\n","import type { CommandTo, iQueue } from './index.d';\r\nimport cluster from 'cluster';\r\nimport { Command } from './command';\r\n\r\nexport class Queue implements iQueue {\r\n  queue: Command[] = [];\r\n\r\n  /**\r\n   * Adds a command to the queue\r\n   */\r\n  add(command: Command) {\r\n    const index = this.queue.push(command);\r\n    return index;\r\n  }\r\n\r\n  /**\r\n   * Removes the first command from the queue\r\n   */\r\n  shift() {\r\n    return this.queue.shift();\r\n  }\r\n\r\n  /**\r\n   * Gets the first command in the queue and may send it to the worker to do\r\n   */\r\n  getNext(to: CommandTo): Command | undefined {\r\n    const command = this.queue.shift();\r\n\r\n    if (command === undefined) {\r\n      return;\r\n    }\r\n\r\n    const newCommand = command.clone('primary', to);\r\n\r\n    return newCommand;\r\n  }\r\n}\r\n","import type { CommandTo, KeyPair } from './index.d';\r\n\r\nimport { Command } from './command';\r\nimport { internalCommands } from './commands';\r\nimport { Primary } from './primary';\r\n\r\nexport function getPrimaryEvents(primary: Primary) {\r\n  return {\r\n    /**\r\n     * @TODO\r\n     */\r\n    getNextJob: () => {\r\n      return primary.process.emit(\r\n        'message',\r\n        new Command(\r\n          internalCommands.getNextPrimaryJob,\r\n          {},\r\n          'primary',\r\n          internalCommands.getNextPrimaryJob\r\n        )\r\n      );\r\n    },\r\n\r\n    /**\r\n     * @TODO\r\n     */\r\n    enqueueJob: (\r\n      command: string,\r\n      args: KeyPair = {},\r\n      to: CommandTo = 'workers'\r\n    ) => {\r\n      if (to === 'primary') {\r\n        return primary.process.emit(\r\n          'message',\r\n          new Command(\r\n            command,\r\n            args,\r\n            'primary',\r\n            internalCommands.enqueueJobPrimary\r\n          )\r\n        );\r\n      } else {\r\n        return primary.process.emit(\r\n          'message',\r\n          new Command(command, args, 'primary', internalCommands.enqueueJob)\r\n        );\r\n      }\r\n    },\r\n\r\n    /**\r\n     * @TODO\r\n     */\r\n    newJobNotice: () => {\r\n      return primary.process.emit(\r\n        'message',\r\n        new Command(\r\n          internalCommands.newJobNotice,\r\n          {},\r\n          'primary',\r\n          internalCommands.newJobNotice\r\n        )\r\n      );\r\n    },\r\n\r\n    /**\r\n     * @TODO\r\n     */\r\n    message: async (command: string, args: KeyPair = {}) => {\r\n      return primary.process.emit(\r\n        'message',\r\n        new Command(command, args, 'primary', internalCommands.message)\r\n      );\r\n    },\r\n  };\r\n}\r\n","import type { CommandTo, KeyPair } from './index.d';\r\n\r\nimport { Command } from './command';\r\nimport { internalCommands } from './commands';\r\nimport { Worker } from './worker';\r\n\r\nexport function getWorkerEvents(worker: Worker) {\r\n  return {\r\n    /**\r\n     * @TODO\r\n     */\r\n    getNextJob: () => {\r\n      return worker.process.send(\r\n        new Command(\r\n          internalCommands.getNextJob,\r\n          {},\r\n          worker.pid,\r\n          internalCommands.getNextJob\r\n        )\r\n      );\r\n    },\r\n\r\n    /**\r\n     * @TODO\r\n     */\r\n    enqueueJob: (\r\n      command: string,\r\n      args: KeyPair = {},\r\n      to: CommandTo = 'workers'\r\n    ) => {\r\n      if (to === 'primary') {\r\n        return worker.process.send(\r\n          new Command(\r\n            command,\r\n            args,\r\n            worker.pid,\r\n            internalCommands.enqueueJobPrimary\r\n          )\r\n        );\r\n      } else {\r\n        return worker.process.send(\r\n          new Command(command, args, worker.pid, internalCommands.enqueueJob)\r\n        );\r\n      }\r\n    },\r\n\r\n    /**\r\n     * @TODO\r\n     */\r\n    newJobNotice: () => {\r\n      return worker.process.send(\r\n        new Command(\r\n          internalCommands.newJobNotice,\r\n          {},\r\n          worker.pid,\r\n          internalCommands.newJobNotice\r\n        )\r\n      );\r\n    },\r\n\r\n    /**\r\n     * @TODO\r\n     */\r\n    message: async (command: string, args: KeyPair = {}) => {\r\n      return worker.process.send(\r\n        new Command(command, args, worker.pid, internalCommands.message)\r\n      );\r\n    },\r\n  };\r\n}\r\n","import type { CommandAction, KeyPair, QuickSends } from './index.d';\r\ntype Process = typeof cluster.worker;\r\n\r\nimport cluster from 'cluster';\r\nimport { Command } from './command';\r\nimport { internalCommands } from './commands';\r\nimport { getWorkerEvents } from './workerEvents';\r\n\r\nexport class Worker {\r\n  process: Process;\r\n  useLogging: boolean;\r\n  state: KeyPair = {};\r\n  sends: QuickSends;\r\n  pid: number;\r\n  isWorking: boolean = false;\r\n\r\n  constructor(\r\n    process: Process,\r\n    onCommand: CommandAction,\r\n    useLogging: boolean = false\r\n  ) {\r\n    this.process = process;\r\n    this.useLogging = useLogging;\r\n    this.pid = this.process.process.pid;\r\n    this.sends = getWorkerEvents(this);\r\n\r\n    /**\r\n     * Primary receives a general message from worker\r\n     */\r\n    process.on(internalCommands.message, async (json: KeyPair) => {\r\n      if (this.isWorking) {\r\n        return;\r\n      }\r\n\r\n      this.isWorking = true;\r\n      const command = Command.fromJSON(json);\r\n\r\n      if (this.useLogging) {\r\n        command.log('primary');\r\n      }\r\n\r\n      switch (command.to) {\r\n        case internalCommands.newJobNotice:\r\n          this.sends.getNextJob();\r\n          break;\r\n\r\n        case internalCommands.message:\r\n          break;\r\n      }\r\n\r\n      const newCommand = await onCommand(command, this.state, this.sends);\r\n\r\n      if (newCommand === undefined) {\r\n        await command.run(this.state, this.sends);\r\n      } else {\r\n        await (newCommand as Command).run(this.state, this.sends);\r\n      }\r\n      this.isWorking = false;\r\n\r\n      this.sends.getNextJob();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Kills the worker\r\n   */\r\n  kill() {\r\n    this.process.removeAllListeners();\r\n    this.process.kill('SIGKILL');\r\n    this.process = undefined;\r\n  }\r\n}\r\n","import { Cluster } from '../src';\r\nimport { test } from 'uvu';\r\nimport * as assert from 'uvu/assert';\r\n\r\ntest('Test primary', async () => {\r\n  const instance = new Cluster(\r\n    [\r\n      {\r\n        command: 'dist',\r\n        action: () => undefined,\r\n      },\r\n      {\r\n        command: 'cli:setText',\r\n        description: 'Sets text in the primary process',\r\n        args: {\r\n          '<text>': 'The name of the state to set',\r\n        },\r\n        options: {\r\n          '-f': 'First character only',\r\n        },\r\n        action: async (command, state, sends) => {\r\n          state.text =\r\n            command.args.f === true\r\n              ? command.args.cli.text[0]\r\n              : command.args.cli.text;\r\n\r\n          console.log('setText', state);\r\n        },\r\n      },\r\n      {\r\n        command: 'iterate',\r\n        action: async (command, state, sends) => {\r\n          if (state.value === undefined) {\r\n            state.value = 0;\r\n          }\r\n\r\n          state.value += 1;\r\n          console.log('Iterated value:', state.value);\r\n        },\r\n      },\r\n    ],\r\n    true\r\n  ).onCommand(\r\n    async (command, state, sends) => {\r\n      console.info(`Primary Message: ${command.command}`);\r\n    },\r\n    async (command, state, sends) => {\r\n      console.info(`Worker Message: ${command.command}`);\r\n      sends.enqueueJob(\r\n        'iterateState',\r\n        {\r\n          commands: 1,\r\n        },\r\n        'primary'\r\n      );\r\n    }\r\n  );\r\n\r\n  await instance.start(\r\n    async (primary) => {\r\n      console.info(`Primary ready`);\r\n      primary.sends.enqueueJob('iterate');\r\n    },\r\n    async (worker) => {\r\n      console.info(`Worker ${worker.pid} ready`);\r\n    }\r\n  );\r\n});\r\n\r\ntest.run();\r\n"],"mappings":"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","names":[]}